# Herkin Workflows
* These workflows outline how Herkin-Admin and Keg-Herkin interact with git and git-providers
* Most actions involving git are automated and transparent to the user

## Workflows

### Provider Authentication / Token
* When a user logs into Herkin-Admin, they must authenticate with a Git Provider (GitHub)
* Once authenticated, the required scopes are requested for interacting with the Provider
  * Scopes include repo access (Read/Write)
* The Provider returns a **token** used to authenticate as the user when a request is made to the provider
* The **token** is securely stored via encryption in the database
* It can only be used by
  * The user that created the token
  * Or other users that have been given access to a repo that belongs to the user
* The **token** is never visually displayed, and is only interacted with programatically
  * At NO time is the token available for visual inspection to anyone, including the Keg-Herkin team
* Every 7 days the **token** is invalidated.
  * After this time, a new token must be generated by logging into the Herkin-Admin application
* Every time a user logs out, then logs in again
  * A new **token** is generated
  * The previous **token** is invalidated
  * This makes generating a new **token** a simple and straight forward process

### Connecting Provider Repository Workflow
* Within Herkin-Admin, users can create Repos (Repo)
  * These repos can be connected to provider repositories (ProRep)
* When a Repo is connected to a ProRep, Herkin-Admin stores the following meta-data
  * `Repo Name` - Name of the repository from the provider
  * `Default Branch` - Main branch all other branches are branched
  * `Git Provider URI` - Used for git actions ( clone / push / pull / commit )
* This metadata along with the token is used later in future workflows

### initializeHerkin Workflow
* A ProRep is cloned to user specific path on mounted volume
  * This path is transparent to the user, and is unimportant
* The user **token** obtained during the auth process, is used here to clone the repo
* After being cloned, a new branch is created from the user defined default branch
* The required Keg-Herkin folder structure and configs are created
* The changes are committed to the previously created branch
* The branch is then pushed to the provider

### setupHerkin Workflow
* The ProRep is not interacted with until it's cloned from the Provider
* This first happens when Keg-Herkin is started by Herkin-Admin
* Herkin-Admin passed the metadata of the repo to Keg-Herkin
* Keg-Herkin then uses that metadata to build the required Keg-Herkin configuration
  * `repository-root/goblet.config.js` - Keg-Herkin configuration file
    * If this file already exists, the **entire workflow** will be stopped
      * Otherwise it could over wright previous created folderpaths
  * `/automation` or `/tests` folder in the root directory with the following structure
    ```
      /repository-root
        - /automation
          - /artifacts
          - /bdd
            - /features
            - /steps
            - /support
          - /reports
          - /unit
          - /waypoint
    ```
  * Provider workflows (TBD)
    * Automation tasks, i.e. (github workflows / actions)

### Git Clone
* The repo URI along with the token acquired when the user logs in to clone the a repo from a provider
* It's cloned to a mounted volume
  * The volume is shared across all instance running Keg-Herkin
  * The repos path on the volume is dynamically generated and not exposed to the user
  * It's not important where the repo live, just that keg-herkin knows where it is
  * Generation of the repo path should be pure, so that the location determined at any give time

### Git Branch
* The user defined default branch for the repo is first branch that is checked out
* From that branch, before any work is done in keg-herkin, a new branch is created from the default
* The branch name is dynamically generated based on the user the initiated the new branch
  * Generation of the branch name should be pure, so that it can be determined at any give time

### Git Commit
* Once changes are made to the repo and the new branch, a git commit is made
* The commit message used is relative to the changes that were made
  * The initial setup commit message look similar to
    * `feat(automation): Keg-Herkin Initial Setup`
  * Changes made via Keg-Herkin Application will have a commit message based on the change file
    * `feat(test): Updates to user-sign-in.feature`
* The committed changes are **always scoped** with one exception
  * Only files within the `keg-herkin root folder` or the `goblet.config.js` file will be committed
  * Any other file changes will be ignored
  * The only exception to this is during the initial setup of Keg-Herkin within the repo

### Git Pull
  * **NOTES** - Investigate this. This may need to be changed or removed
* When a new Keg-Herkin session is started
* A check with the provider is made to validate active branches
* If the remote provider contains a corresponding branch of the same name
  * The remote branch is pulled and merged with the local
  * Any conflicts are resolved automatically with the local having priority

### Git Push
* The repo branches are pushed to the git provider
  * Uses the repo URI along with the token acquired when the user logs in
* Pushed branches are **always scoped** to only branches created by Keg-Herkin
  * Any branch not created by Keg-Herkin will never have commits push to a remove via Keg-Herkin
